{% extends 'base.html' %}
{% load static %}

{% block title %}Predictive Maintenance - AI/ML Powered{% endblock %}

{% block extra_css %}
<style>
    .ml-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
        height: 500px;
    }

    .ml-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #e74c3c;
        padding-bottom: 10px;
    }

    .ml-card-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
    }

    .info-icon {
        cursor: pointer;
        color: #e74c3c;
        font-size: 20px;
        transition: color 0.3s;
    }

    .info-icon:hover {
        color: #c0392b;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 15px;
    }

    .metric-box {
        background: #fee;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 14px;
    }

    .risk-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .risk-low { background: #2ecc71; color: white; }
    .risk-medium { background: #f39c12; color: white; }
    .risk-high { background: #e74c3c; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="fas fa-tools"></i> Predictive Maintenance - AI/ML Powered
            </h2>
            <p class="text-muted">Advanced predictive analytics using 4 AI/ML models</p>
        </div>
    </div>

    <!-- Data Source Toggle -->
    <div class="row mb-3">
        <div class="col-12">
            <label class="switch">
                <input type="checkbox" id="dataSourceToggle">
                <span class="slider round"></span>
            </label>
            <span id="dataSourceLabel" class="ml-2">Real-time Data</span>
        </div>
    </div>

    <!-- Row 1: 2 columns -->
    <div class="row">
        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-exclamation-circle"></i> Equipment Failure Prediction
                    </div>
                </div>
                <div>
                    <span>Risk Level:</span>
                    <span id="failureRisk" class="risk-badge risk-low">Low</span>
                    <div class="metric-box">
                        <strong>Failure Probability:</strong> <span id="failureProb">0%</span><br>
                        <strong>Est. Time to Failure:</strong> <span id="ttf">365 days</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="failureChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-bolt"></i> Overload Risk Classification
                    </div>
                </div>
                <div>
                    <span>Risk Level:</span>
                    <span id="overloadRisk" class="risk-badge risk-low">Low</span>
                    <div class="metric-box">
                        <strong>Current Load:</strong> <span id="loadPct">0%</span><br>
                        <strong>Peak Phase:</strong> <span id="peakPhase">A</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="overloadChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: 2 columns -->
    <div class="row">
        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-tachometer-alt"></i> Power Quality Index
                    </div>
                </div>
                <div>
                    <span>PQI Score:</span>
                    <span id="pqiScore">100</span>
                    <span class="ml-3">Grade:</span>
                    <span id="pqiGrade" class="risk-badge risk-low">Excellent</span>
                </div>
                <div class="chart-container">
                    <canvas id="pqiChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-arrow-down"></i> Voltage Sag Prediction
                    </div>
                </div>
                <div>
                    <span>Sag Risk:</span>
                    <span id="sagRisk" class="risk-badge risk-low">Low</span>
                    <div class="metric-box">
                        <strong>Probability:</strong> <span id="sagProb">0%</span><br>
                        <strong>Expected Duration:</strong> <span id="sagDuration">0 ms</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sagChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Use global API_URL from base.html
    const token = '{{ request.session.access_token }}';
    let isSimulation = false;
    let failureChart, overloadChart, pqiChart, sagChart;

    function initCharts() {
        console.log('Initializing charts...');

        // Equipment Failure Chart
        const failureCtx = document.getElementById('failureChart').getContext('2d');
        failureChart = new Chart(failureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Failure Probability (%)',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        // Overload Risk Chart
        const overloadCtx = document.getElementById('overloadChart').getContext('2d');
        overloadChart = new Chart(overloadCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Load Percentage',
                    data: [],
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 120 }
                }
            }
        });

        // PQI Chart
        const pqiCtx = document.getElementById('pqiChart').getContext('2d');
        pqiChart = new Chart(pqiCtx, {
            type: 'bar',
            data: {
                labels: ['Voltage Quality', 'Frequency Quality', 'Power Factor Quality'],
                datasets: [{
                    label: 'Quality Score',
                    data: [100, 100, 100],
                    backgroundColor: ['#3498db', '#2ecc71', '#9b59b6']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        // Voltage Sag Chart
        const sagCtx = document.getElementById('sagChart').getContext('2d');
        sagChart = new Chart(sagCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sag Probability (%)',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                }
            }
        });

        console.log('Charts initialized successfully');
    }

    async function updateVisualizations() {
        try {
            const params = isSimulation ? '?is_simulation=true' : '?is_simulation=false';
            console.log('Fetching ML data...', API_URL);

            // Equipment Failure
            const failureResp = await fetch(`${API_URL}/api/ml/maintenance/equipment-failure${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!failureResp.ok) {
                console.error('Failure API error:', failureResp.status);
                return;
            }

            const failureData = await failureResp.json();
            console.log('Failure data:', failureData);
            updateFailureChart(failureData.data);

            // Overload Risk
            const overloadResp = await fetch(`${API_URL}/api/ml/maintenance/overload-risk${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const overloadData = await overloadResp.json();
            updateOverloadChart(overloadData.data);

            // PQI
            const pqiResp = await fetch(`${API_URL}/api/ml/maintenance/power-quality-index${params}&hours=1`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const pqiData = await pqiResp.json();
            updatePQIChart(pqiData.data);

            // Voltage Sag
            const sagResp = await fetch(`${API_URL}/api/ml/maintenance/voltage-sag${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const sagData = await sagResp.json();
            updateSagChart(sagData.data);

        } catch (error) {
            console.error('Error fetching ML data:', error);
        }
    }

    function updateFailureChart(data) {
        if (!data || data.length === 0) {
            console.log('No failure data');
            return;
        }

        const latest = data[data.length - 1];
        const labels = data.slice(-30).map(d => new Date(d.timestamp).toLocaleTimeString());
        const probs = data.slice(-30).map(d => d.failure_probability * 100);

        failureChart.data.labels = labels;
        failureChart.data.datasets[0].data = probs;
        failureChart.update();

        document.getElementById('failureRisk').textContent = latest.risk_level;
        document.getElementById('failureRisk').className =
            latest.risk_level === 'High' ? 'risk-badge risk-high' :
            latest.risk_level === 'Medium' ? 'risk-badge risk-medium' : 'risk-badge risk-low';
        document.getElementById('failureProb').textContent = `${(latest.failure_probability * 100).toFixed(1)}%`;
        document.getElementById('ttf').textContent = `${latest.estimated_days_to_failure} days`;
    }

    function updateOverloadChart(data) {
        if (!data || data.length === 0) return;

        const latest = data[data.length - 1];
        const labels = data.slice(-30).map(d => new Date(d.timestamp).toLocaleTimeString());
        const loads = data.slice(-30).map(d => d.current_load_pct);

        overloadChart.data.labels = labels;
        overloadChart.data.datasets[0].data = loads;
        overloadChart.update();

        document.getElementById('overloadRisk').textContent = latest.risk_level;
        document.getElementById('overloadRisk').className =
            latest.risk_level === 'High' ? 'risk-badge risk-high' :
            latest.risk_level === 'Medium' ? 'risk-badge risk-medium' : 'risk-badge risk-low';
        document.getElementById('loadPct').textContent = `${latest.current_load_pct.toFixed(1)}%`;
        document.getElementById('peakPhase').textContent = latest.peak_phase;
    }

    function updatePQIChart(data) {
        if (!data || data.length === 0) return;

        const latest = data[data.length - 1];
        pqiChart.data.datasets[0].data = [
            latest.voltage_quality,
            latest.frequency_quality,
            latest.power_factor_quality
        ];
        pqiChart.update();

        document.getElementById('pqiScore').textContent = latest.pqi_score.toFixed(1);
        document.getElementById('pqiGrade').textContent = latest.grade;
    }

    function updateSagChart(data) {
        if (!data || data.length === 0) return;

        const latest = data[data.length - 1];
        const labels = data.slice(-30).map(d => new Date(d.timestamp).toLocaleTimeString());
        const probs = data.slice(-30).map(d => d.sag_probability * 100);

        sagChart.data.labels = labels;
        sagChart.data.datasets[0].data = probs;
        sagChart.update();

        document.getElementById('sagRisk').textContent = latest.risk_level;
        document.getElementById('sagRisk').className =
            latest.risk_level === 'High' ? 'risk-badge risk-high' :
            latest.risk_level === 'Medium' ? 'risk-badge risk-medium' : 'risk-badge risk-low';
        document.getElementById('sagProb').textContent = `${(latest.sag_probability * 100).toFixed(1)}%`;
        document.getElementById('sagDuration').textContent = `${latest.expected_duration_ms} ms`;
    }

    document.getElementById('dataSourceToggle').addEventListener('change', function() {
        isSimulation = this.checked;
        document.getElementById('dataSourceLabel').textContent = isSimulation ? 'Simulator Data' : 'Real-time Data';
        updateVisualizations();
    });

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        initCharts();
        updateVisualizations();
        setInterval(updateVisualizations, 5000);
    });
</script>
{% endblock %}
