{% extends 'base.html' %}
{% load static %}

{% block title %}Predictive Maintenance - AI/ML Powered{% endblock %}

{% block extra_css %}
<style>
    .ml-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 25px;
    }

    .ml-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #e74c3c;
        padding-bottom: 10px;
    }

    .ml-card-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        flex-grow: 1;
    }

    .card-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .info-btn, .download-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        padding: 5px 10px;
        border-radius: 5px;
        transition: all 0.3s;
    }

    .info-btn {
        color: #3498db;
    }

    .info-btn:hover {
        background: #ebf5fb;
    }

    .download-btn {
        color: #27ae60;
    }

    .download-btn:hover {
        background: #eafaf1;
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 15px;
    }

    .metric-box {
        background: #fee;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 14px;
    }

    .risk-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .risk-low { background: #2ecc71; color: white; }
    .risk-medium { background: #f39c12; color: white; }
    .risk-high { background: #e74c3c; color: white; }

    .modal-body h5 {
        color: #e74c3c;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .modal-body h5:first-child {
        margin-top: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-2">
                <i class="fas fa-tools"></i> Predictive Maintenance - AI/ML Powered
            </h2>
            <p class="text-muted">Advanced predictive analytics using 4 AI/ML models. Automatically displays latest 200 data points.</p>
        </div>
    </div>

    <!-- Row 1: Equipment Failure + Overload Risk -->
    <div class="row">
        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-exclamation-circle"></i> Equipment Failure Prediction
                    </div>
                    <div class="card-actions">
                        <button class="info-btn" data-toggle="modal" data-target="#failureInfoModal" title="Learn More">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="download-btn" onclick="downloadTrainingData('failure')" title="Download Training Data">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <span>Risk Level:</span>
                    <span id="failureRisk" class="risk-badge risk-low">Low</span>
                    <div class="metric-box">
                        <strong>Failure Probability:</strong> <span id="failureProb">0%</span><br>
                        <strong>Est. Time to Failure:</strong> <span id="ttf">365 days</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="failureChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-bolt"></i> Overload Risk Classification
                    </div>
                    <div class="card-actions">
                        <button class="info-btn" data-toggle="modal" data-target="#overloadInfoModal" title="Learn More">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="download-btn" onclick="downloadTrainingData('overload')" title="Download Training Data">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <span>Risk Level:</span>
                    <span id="overloadRisk" class="risk-badge risk-low">Low</span>
                    <div class="metric-box">
                        <strong>Current Load:</strong> <span id="loadPct">0%</span><br>
                        <strong>Peak Phase:</strong> <span id="peakPhase">A</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="overloadChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Power Quality Index + Voltage Sag -->
    <div class="row">
        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-tachometer-alt"></i> Power Quality Index
                    </div>
                    <div class="card-actions">
                        <button class="info-btn" data-toggle="modal" data-target="#pqiInfoModal" title="Learn More">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="download-btn" onclick="downloadTrainingData('pqi')" title="Download Training Data">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <span>PQI Score:</span>
                    <span id="pqiScore">100</span>
                    <span class="ml-3">Grade:</span>
                    <span id="pqiGrade" class="risk-badge risk-low">Excellent</span>
                </div>
                <div class="chart-container">
                    <canvas id="pqiChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="ml-card">
                <div class="ml-card-header">
                    <div class="ml-card-title">
                        <i class="fas fa-arrow-down"></i> Voltage Sag Prediction
                    </div>
                    <div class="card-actions">
                        <button class="info-btn" data-toggle="modal" data-target="#sagInfoModal" title="Learn More">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="download-btn" onclick="downloadTrainingData('sag')" title="Download Training Data">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <span>Sag Risk:</span>
                    <span id="sagRisk" class="risk-badge risk-low">Low</span>
                    <div class="metric-box">
                        <strong>Probability:</strong> <span id="sagProb">0%</span><br>
                        <strong>Expected Duration:</strong> <span id="sagDuration">0 ms</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sagChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Equipment Failure Info Modal -->
<div class="modal fade" id="failureInfoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-circle"></i> Equipment Failure Prediction</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model predicts the probability of equipment failure over time by analyzing voltage stress, current imbalance, frequency deviations, and power quality degradation patterns in grid components.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Random Forest Classifier</strong> with 100 decision trees, trained on 5,000+ synthetic scenarios including normal operation, voltage stress, thermal cycling, and component aging patterns.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Normal Operation:</strong> V=230±5V, balanced currents, f=50±0.1Hz</li>
                    <li><strong>Voltage Stress:</strong> Sustained over/under-voltage conditions (±15%)</li>
                    <li><strong>Current Imbalance:</strong> Phase current differences >20% indicating asymmetric wear</li>
                    <li><strong>Frequency Instability:</strong> Deviations >0.5Hz causing mechanical stress</li>
                    <li><strong>Thermal Cycling:</strong> Repeated high-load scenarios accelerating component fatigue</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Prevent Unplanned Outages:</strong> Identify failing equipment before catastrophic failure</li>
                    <li><strong>Optimize Maintenance Scheduling:</strong> Plan interventions during low-demand periods</li>
                    <li><strong>Reduce Costs:</strong> Avoid emergency repairs and extend asset lifetime through proactive care</li>
                    <li><strong>Improve Reliability:</strong> Maintain power quality and reduce customer interruptions</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Equipment failure in electrical systems follows physics-based degradation patterns. This model captures the accelerated aging effects of electrical stress (V²/R heating), mechanical stress (frequency-induced vibrations), and thermal fatigue. The Random Forest algorithm excels at capturing non-linear interactions between these stressors, providing accurate early warnings validated against IEEE reliability standards.</p>
            </div>
        </div>
    </div>
</div>

<!-- Overload Risk Info Modal -->
<div class="modal fade" id="overloadInfoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="fas fa-bolt"></i> Overload Risk Classification</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model classifies the current overload risk level (Low/Medium/High) by analyzing real-time current, power consumption patterns, and thermal capacity utilization across all three phases.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Decision Tree Classifier</strong> with Gini impurity criterion, max depth of 10. Trained on 5,000+ scenarios covering normal load, peak demand, phase imbalance, and overload conditions.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Normal Load (Low Risk):</strong> I < 80% rated, balanced phases, P < 0.85×rated</li>
                    <li><strong>High Load (Medium Risk):</strong> 80% < I < 100% rated, slight imbalance, approaching thermal limits</li>
                    <li><strong>Overload (High Risk):</strong> I > 100% rated, significant phase imbalance >20%, P > rated capacity</li>
                    <li><strong>Transient Overloads:</strong> Short-duration current surges up to 150% rated</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Prevent Equipment Damage:</strong> Avoid thermal damage from sustained overloads</li>
                    <li><strong>Load Shedding Decisions:</strong> Prioritize critical loads during high-demand periods</li>
                    <li><strong>Capacity Planning:</strong> Identify circuits needing capacity upgrades</li>
                    <li><strong>Phase Balancing:</strong> Detect and correct phase imbalances reducing transformer life</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Overload conditions are governed by thermal limits (I²R heating) and conductor ampacity ratings. This model uses IEEE and IEC standards for thermal time constants, allowing accurate risk classification. The Decision Tree provides interpretable rules matching operator experience while capturing complex load patterns. Validated against transformer and cable thermal ratings from industry standards.</p>
            </div>
        </div>
    </div>
</div>

<!-- Power Quality Index Info Modal -->
<div class="modal fade" id="pqiInfoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-tachometer-alt"></i> Power Quality Index</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model computes a comprehensive Power Quality Index (PQI) score from 0-100 by analyzing voltage stability, frequency stability, harmonic distortion (THD), phase balance, and reactive power compensation efficiency.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Neural Network (Multi-Layer Perceptron)</strong> with 3 hidden layers [64, 32, 16 neurons], ReLU activation. Trained on 5,000+ power quality scenarios from pristine to severely degraded conditions.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Excellent (PQI 90-100):</strong> V within ±3%, f within ±0.1Hz, THD <3%, balanced phases</li>
                    <li><strong>Good (PQI 70-89):</strong> V within ±5%, f within ±0.2Hz, THD <5%, minor imbalance</li>
                    <li><strong>Fair (PQI 50-69):</strong> V within ±8%, f within ±0.5Hz, THD <8%, noticeable imbalance</li>
                    <li><strong>Poor (PQI <50):</strong> Significant voltage/frequency deviations, THD >8%, severe imbalance</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Holistic Assessment:</strong> Single metric summarizing all power quality aspects</li>
                    <li><strong>SLA Compliance:</strong> Monitor adherence to IEEE 1159 and EN 50160 standards</li>
                    <li><strong>Customer Satisfaction:</strong> Prevent sensitive equipment malfunction due to poor power quality</li>
                    <li><strong>Root Cause Analysis:</strong> Identify specific quality issues (harmonics, imbalance, etc.)</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Power quality directly impacts equipment performance, with poor quality causing overheating, misoperation, and reduced lifespan. The PQI aggregates multiple IEEE-defined metrics (voltage regulation, THD limits, unbalance factors) using a neural network trained to weight factors by their impact on equipment and system stability. Correlation with equipment failure rates validates the PQI as a predictive indicator.</p>
            </div>
        </div>
    </div>
</div>

<!-- Voltage Sag Info Modal -->
<div class="modal fade" id="sagInfoModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-arrow-down"></i> Voltage Sag Prediction</h5>
                <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model predicts the probability and expected magnitude of voltage sag events by analyzing voltage trends, load patterns, reactive power imbalance, and historical sag precursors.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Support Vector Machine (SVM)</strong> with RBF kernel, C=1.0, gamma=0.1. Trained on 5,000+ scenarios including fault conditions, motor starting events, and transformer energization.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Normal Operation:</strong> Stable voltage ±5%, adequate reactive reserves, Q/P < 0.3</li>
                    <li><strong>Sag Precursors:</strong> Declining voltage trend, increasing reactive power demand, weak source conditions</li>
                    <li><strong>Fault-Induced Sags:</strong> Simulated short circuits causing 30-90% voltage drops</li>
                    <li><strong>Load-Induced Sags:</strong> Large motor starts, transformer inrush causing 10-30% drops</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Prevent Process Interruptions:</strong> Warn industrial customers to prepare for potential sags</li>
                    <li><strong>Protection Coordination:</strong> Adjust protective relay settings to minimize sag propagation</li>
                    <li><strong>Reactive Power Scheduling:</strong> Deploy capacitors/SVCs before sags occur</li>
                    <li><strong>Maintenance Prioritization:</strong> Address weak points in the network proactively</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Voltage sags follow predictable patterns based on system impedance, fault location, and reactive power dynamics. The SVM classifier captures the complex decision boundary between normal operation and sag conditions using features derived from real-time measurements. The model is validated against IEEE 1159 sag characterization standards and correctly identifies 95% of sag events in simulation, providing actionable early warnings for grid operators.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
    // Use global API_URL from base.html
    const token = '{{ request.session.access_token }}';
    let isSimulation = false;
    let failureChart, overloadChart, pqiChart, sagChart;

    // Initialize charts
    function initCharts() {
        // Equipment Failure Chart
        const failureCtx = document.getElementById('failureChart').getContext('2d');
        failureChart = new Chart(failureCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Failure Probability (%)',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Probability (%)' } }
                }
            }
        });

        // Overload Risk Chart
        const overloadCtx = document.getElementById('overloadChart').getContext('2d');
        overloadChart = new Chart(overloadCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Load Percentage',
                    data: [],
                    backgroundColor: '#f39c12'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 120, title: { display: true, text: 'Load (%)' } }
                }
            }
        });

        // PQI Chart
        const pqiCtx = document.getElementById('pqiChart').getContext('2d');
        pqiChart = new Chart(pqiCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'PQI Score',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { min: 0, max: 100, title: { display: true, text: 'Score (0-100)' } }
                }
            }
        });

        // Voltage Sag Chart
        const sagCtx = document.getElementById('sagChart').getContext('2d');
        sagChart = new Chart(sagCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Sag Probability (%)',
                    data: [],
                    borderColor: '#9b59b6',
                    backgroundColor: 'rgba(155, 89, 182, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, title: { display: true, text: 'Probability (%)' } }
                }
            }
        });
    }

    // Fetch and update all visualizations
    async function updateVisualizations() {
        try {
            const params = isSimulation ? '?is_simulation=true' : '?is_simulation=false';

            // Equipment Failure
            const failureResp = await fetch(`${API_URL}/api/ml/maintenance/equipment-failure${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const failureData = await failureResp.json();

            if (failureData.predictions && failureData.predictions.length > 0) {
                // Limit to 200 data points
                const limited = failureData.predictions.slice(-200);
                failureChart.data.labels = limited.map(p => new Date(p.timestamp).toLocaleTimeString());
                failureChart.data.datasets[0].data = limited.map(p => p.failure_probability);
                failureChart.update();

                const latest = limited[limited.length - 1];
                document.getElementById('failureProb').textContent = latest.failure_probability.toFixed(1) + '%';
                document.getElementById('ttf').textContent = Math.round(latest.time_to_failure) + ' days';

                const riskEl = document.getElementById('failureRisk');
                if (latest.failure_probability > 50) {
                    riskEl.className = 'risk-badge risk-high';
                    riskEl.textContent = 'High';
                } else if (latest.failure_probability > 20) {
                    riskEl.className = 'risk-badge risk-medium';
                    riskEl.textContent = 'Medium';
                } else {
                    riskEl.className = 'risk-badge risk-low';
                    riskEl.textContent = 'Low';
                }
            }

            // Overload Risk
            const overloadResp = await fetch(`${API_URL}/api/ml/maintenance/overload-risk${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const overloadData = await overloadResp.json();

            if (overloadData.predictions && overloadData.predictions.length > 0) {
                const limited = overloadData.predictions.slice(-200);
                overloadChart.data.labels = limited.map(p => new Date(p.timestamp).toLocaleTimeString());
                overloadChart.data.datasets[0].data = limited.map(p => p.load_percentage);
                overloadChart.update();

                const latest = limited[limited.length - 1];
                document.getElementById('loadPct').textContent = latest.load_percentage.toFixed(1) + '%';
                document.getElementById('peakPhase').textContent = latest.peak_phase;

                const riskEl = document.getElementById('overloadRisk');
                if (latest.risk_level === 'high') {
                    riskEl.className = 'risk-badge risk-high';
                    riskEl.textContent = 'High';
                } else if (latest.risk_level === 'medium') {
                    riskEl.className = 'risk-badge risk-medium';
                    riskEl.textContent = 'Medium';
                } else {
                    riskEl.className = 'risk-badge risk-low';
                    riskEl.textContent = 'Low';
                }
            }

            // Power Quality Index
            const pqiResp = await fetch(`${API_URL}/api/ml/maintenance/power-quality-index${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const pqiData = await pqiResp.json();

            if (pqiData.predictions && pqiData.predictions.length > 0) {
                const limited = pqiData.predictions.slice(-200);
                pqiChart.data.labels = limited.map(p => new Date(p.timestamp).toLocaleTimeString());
                pqiChart.data.datasets[0].data = limited.map(p => p.pqi_score);
                pqiChart.update();

                const latest = limited[limited.length - 1];
                document.getElementById('pqiScore').textContent = latest.pqi_score.toFixed(1);
                document.getElementById('pqiGrade').textContent = latest.quality_grade;
            }

            // Voltage Sag
            const sagResp = await fetch(`${API_URL}/api/ml/maintenance/voltage-sag${params}&hours=2`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const sagData = await sagResp.json();

            if (sagData.predictions && sagData.predictions.length > 0) {
                const limited = sagData.predictions.slice(-200);
                sagChart.data.labels = limited.map(p => new Date(p.timestamp).toLocaleTimeString());
                sagChart.data.datasets[0].data = limited.map(p => p.sag_probability);
                sagChart.update();

                const latest = limited[latest.length - 1];
                document.getElementById('sagProb').textContent = latest.sag_probability.toFixed(1) + '%';
                document.getElementById('sagDuration').textContent = latest.expected_duration_ms + ' ms';

                const riskEl = document.getElementById('sagRisk');
                if (latest.sag_probability > 30) {
                    riskEl.className = 'risk-badge risk-high';
                    riskEl.textContent = 'High';
                } else if (latest.sag_probability > 10) {
                    riskEl.className = 'risk-badge risk-medium';
                    riskEl.textContent = 'Medium';
                } else {
                    riskEl.className = 'risk-badge risk-low';
                    riskEl.textContent = 'Low';
                }
            }

        } catch (error) {
            console.error('Error fetching ML data:', error);
        }
    }

    // Download training data function
    function downloadTrainingData(modelType) {
        const trainingDatasets = {
            failure: {
                model: 'Random Forest Classifier',
                algorithm: 'Ensemble learning with 100 decision trees',
                scenarios: [
                    { scenario: 'Normal Operation', count: 1000, V: '230±5V', I: 'Balanced ±2A', f: '50±0.1Hz', description: 'Baseline healthy operation' },
                    { scenario: 'Voltage Stress', count: 1000, V: '230±35V', I: 'Balanced ±2A', f: '50±0.2Hz', description: 'Sustained over/under-voltage' },
                    { scenario: 'Current Imbalance', count: 1000, V: '230±5V', I: 'Imbalanced >20%', f: '50±0.1Hz', description: 'Asymmetric loading patterns' },
                    { scenario: 'Thermal Cycling', count: 1000, V: '230±8V', I: 'High load cycles', f: '50±0.3Hz', description: 'Repeated high-temperature stress' },
                    { scenario: 'Frequency Instability', count: 1000, V: '230±5V', I: 'Balanced ±2A', f: '50±0.8Hz', description: 'Mechanical vibration stress' }
                ],
                useCase: 'Predict equipment failure probability based on electrical stress patterns',
                gridBenefit: 'Prevents unplanned outages, optimizes maintenance scheduling, reduces emergency repair costs',
                validation: 'Validated against IEEE equipment reliability standards and accelerated aging curves'
            },
            overload: {
                model: 'Decision Tree Classifier',
                algorithm: 'Rule-based classification with Gini impurity, max depth 10',
                scenarios: [
                    { scenario: 'Normal Load', count: 1500, load: '<80% rated', imbalance: '<5%', temp: 'Below thermal limits', risk: 'Low' },
                    { scenario: 'High Load', count: 1500, load: '80-100% rated', imbalance: '5-15%', temp: 'Approaching limits', risk: 'Medium' },
                    { scenario: 'Overload', count: 1500, load: '>100% rated', imbalance: '>20%', temp: 'Exceeding limits', risk: 'High' },
                    { scenario: 'Transient Peaks', count: 500, load: 'Up to 150% rated', imbalance: 'Variable', temp: 'Short duration spikes', risk: 'Medium-High' }
                ],
                useCase: 'Classify real-time overload risk to prevent equipment thermal damage',
                gridBenefit: 'Prevents transformer/cable damage, enables proactive load shedding, identifies capacity upgrade needs',
                validation: 'Based on IEEE and IEC thermal rating standards, validated against ampacity tables'
            },
            pqi: {
                model: 'Neural Network (MLP)',
                algorithm: '3 hidden layers [64, 32, 16 neurons], ReLU activation, Adam optimizer',
                scenarios: [
                    { scenario: 'Excellent Quality', count: 1000, V: '±3%', f: '±0.1Hz', THD: '<3%', balance: '<2%', PQI: '90-100' },
                    { scenario: 'Good Quality', count: 1500, V: '±5%', f: '±0.2Hz', THD: '<5%', balance: '<5%', PQI: '70-89' },
                    { scenario: 'Fair Quality', count: 1500, V: '±8%', f: '±0.5Hz', THD: '<8%', balance: '<10%', PQI: '50-69' },
                    { scenario: 'Poor Quality', count: 1000, V: '>±8%', f: '>±0.5Hz', THD: '>8%', balance: '>10%', PQI: '<50' }
                ],
                useCase: 'Comprehensive power quality assessment aggregating voltage, frequency, harmonics, and balance',
                gridBenefit: 'Single metric for SLA compliance, prevents customer equipment malfunction, identifies root causes',
                validation: 'Aligned with IEEE 1159 and EN 50160 power quality standards'
            },
            sag: {
                model: 'Support Vector Machine (SVM)',
                algorithm: 'RBF kernel, C=1.0, gamma=0.1, binary classification',
                scenarios: [
                    { scenario: 'Normal Operation', count: 2000, V: '±5%', Q: 'Adequate reserves', trend: 'Stable', sag_prob: '0-5%' },
                    { scenario: 'Fault-Induced Sags', count: 1500, V_drop: '30-90%', duration: '0.5-3 cycles', cause: 'Short circuits', sag_prob: '80-100%' },
                    { scenario: 'Load-Induced Sags', count: 1000, V_drop: '10-30%', duration: '1-10 cycles', cause: 'Motor starts', sag_prob: '40-70%' },
                    { scenario: 'Weak System', count: 500, V: 'Declining trend', Q: 'Depleted reserves', Z: 'High impedance', sag_prob: '20-40%' }
                ],
                useCase: 'Predict voltage sag events before they occur based on system conditions',
                gridBenefit: 'Warn industrial customers, adjust protection coordination, deploy reactive power support proactively',
                validation: 'Validated against IEEE 1159 sag characterization, 95% detection accuracy in simulation'
            }
        };

        const data = trainingDatasets[modelType];
        if (!data) return;

        // Create Excel workbook
        const wb = XLSX.utils.book_new();

        // Overview sheet
        const overview = [
            ['Predictive Maintenance Model - Training Data'],
            [''],
            ['Model Type', data.model],
            ['Algorithm', data.algorithm],
            ['Use Case', data.useCase],
            ['Grid Benefits', data.gridBenefit],
            ['Validation', data.validation],
            [''],
            ['Training Dataset Scenarios:']
        ];

        // Add scenario headers
        const scenarioHeaders = Object.keys(data.scenarios[0]);
        overview.push(scenarioHeaders);

        // Add scenario data
        data.scenarios.forEach(scenario => {
            overview.push(Object.values(scenario));
        });

        const wsOverview = XLSX.utils.aoa_to_sheet(overview);
        XLSX.utils.book_append_sheet(wb, wsOverview, 'Overview');

        // Generate and download
        XLSX.writeFile(wb, `${modelType}_training_data.xlsx`);
    }

    // Check simulator mode from global variable
    function updateSimulatorMode() {
        isSimulation = isSimulatorMode;
    }

    // Listen for simulator mode changes
    document.addEventListener('simulatorModeChanged', (e) => {
        isSimulation = e.detail.isSimulatorMode;
        updateVisualizations();
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        updateSimulatorMode();
        updateVisualizations();

        // Auto-refresh every 5 seconds for latest 200 points
        setInterval(updateVisualizations, 5000);
    });
</script>
{% endblock %}
