{% extends 'base.html' %}
{% load static %}

{% block title %}Real-time Monitoring - AI/ML Powered{% endblock %}

{% block extra_css %}
<style>
    .ml-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 25px;
    }

    .ml-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .ml-card-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        flex-grow: 1;
    }

    .info-btn {
        background: #3498db;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        padding: 8px 16px;
        border-radius: 5px;
        transition: all 0.3s;
        color: white;
    }

    .info-btn:hover {
        background: #2980b9;
        transform: scale(1.05);
    }

    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 15px;
    }

    .metric-box {
        background: #e3f2fd;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        font-size: 14px;
    }

    .risk-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }

    .risk-low { background: #2ecc71; color: white; }
    .risk-medium { background: #f39c12; color: white; }
    .risk-high { background: #e74c3c; color: white; }

    /* Grid layout for 2 columns */
    .graphs-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin-bottom: 30px;
    }

    @media (max-width: 968px) {
        .graphs-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        overflow-y: auto;
    }

    .modal.show {
        display: block;
    }

    .modal-dialog {
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
    }

    .modal-content {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header.bg-danger {
        background: #e74c3c;
        color: white;
    }

    .modal-header.bg-warning {
        background: #f39c12;
        color: #333;
    }

    .modal-header.bg-info {
        background: #3498db;
        color: white;
    }

    .modal-title {
        margin: 0;
        font-size: 20px;
    }

    .close {
        background: none;
        border: none;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: inherit;
        line-height: 1;
        padding: 0;
    }

    .close:hover {
        opacity: 0.7;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-body h5 {
        color: #3498db;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 16px;
    }

    .modal-body h5:first-child {
        margin-top: 0;
    }

    .modal-body p {
        line-height: 1.6;
        margin-bottom: 15px;
    }

    .modal-body ul {
        margin-left: 20px;
        margin-bottom: 15px;
    }

    .modal-body ul li {
        margin-bottom: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div style="margin-bottom: 30px;">
        <h2 style="margin-bottom: 10px;">
            <i class="fas fa-brain"></i> Real-time Monitoring - AI/ML Powered
        </h2>
        <p style="color: #666;">Advanced real-time analytics using 4 AI/ML models. Automatically displays latest 200 data points.</p>
    </div>

    <!-- Row 1: Voltage Anomaly Detection + Harmonic Analysis -->
    <div class="graphs-grid">
        <div class="ml-card">
            <div class="ml-card-header">
                <div class="ml-card-title">
                    <i class="fas fa-exclamation-triangle"></i> Voltage Anomaly Detection
                </div>
                <button class="info-btn" onclick="openModal('voltageAnomalyModal')" title="Learn More">
                    Info
                </button>
            </div>
            <div>
                <span>Status:</span>
                <span id="voltageStatus" class="risk-badge risk-low">Normal</span>
                <div class="metric-box">
                    <strong>Anomaly Score:</strong> <span id="anomalyScore">0.0</span><br>
                    <strong>Avg Voltage:</strong> <span id="avgVoltage">230V</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="voltageAnomalyChart"></canvas>
            </div>
        </div>

        <div class="ml-card">
            <div class="ml-card-header">
                <div class="ml-card-title">
                    <i class="fas fa-wave-square"></i> Harmonic Analysis
                </div>
                <button class="info-btn" onclick="openModal('harmonicModal')" title="Learn More">
                    Info
                </button>
            </div>
            <div>
                <span>THD Level:</span>
                <span id="thdLevel" class="risk-badge risk-low">Low</span>
                <div class="metric-box">
                    <strong>THD:</strong> <span id="thdValue">0%</span><br>
                    <strong>Category:</strong> <span id="thdCategory">Excellent</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="harmonicChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Row 2: Frequency Stability Prediction + Phase Imbalance Classification -->
    <div class="graphs-grid">
        <div class="ml-card">
            <div class="ml-card-header">
                <div class="ml-card-title">
                    <i class="fas fa-chart-line"></i> Frequency Stability Prediction
                </div>
                <button class="info-btn" onclick="openModal('frequencyModal')" title="Learn More">
                    Info
                </button>
            </div>
            <div>
                <span>Stability Score:</span>
                <span id="stabilityScore">100</span>
                <span style="margin-left: 15px;">Trend:</span>
                <span id="frequencyTrend" class="risk-badge risk-low">Stable</span>
            </div>
            <div class="chart-container">
                <canvas id="frequencyChart"></canvas>
            </div>
        </div>

        <div class="ml-card">
            <div class="ml-card-header">
                <div class="ml-card-title">
                    <i class="fas fa-balance-scale"></i> Phase Imbalance Classification
                </div>
                <button class="info-btn" onclick="openModal('imbalanceModal')" title="Learn More">
                    Info
                </button>
            </div>
            <div>
                <span>Severity:</span>
                <span id="imbalanceSeverity" class="risk-badge risk-low">Normal</span>
                <div class="metric-box">
                    <strong>Balance Score:</strong> <span id="balanceScore">100</span><br>
                    <strong>Max Imbalance:</strong> <span id="maxImbalance">0%</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="imbalanceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Voltage Anomaly Detection Info Modal -->
<div class="modal" id="voltageAnomalyModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Voltage Anomaly Detection</h5>
                <button class="close" onclick="closeModal('voltageAnomalyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model detects abnormal voltage patterns in real-time by analyzing voltage levels across all three phases, identifying deviations from normal operating ranges that could indicate equipment problems or grid disturbances.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Isolation Forest (Unsupervised Anomaly Detection)</strong> with 100 estimators, contamination factor of 0.1. Uses decision trees to isolate anomalies by randomly selecting features and split values.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Normal Operation:</strong> 2,000 samples with V=230±5V, balanced phases, stable power factor</li>
                    <li><strong>Voltage Sags:</strong> 250 samples with voltage drops of 10-40% duration 100-500ms</li>
                    <li><strong>Voltage Swells:</strong> 150 samples with voltage increases of 10-30% short duration</li>
                    <li><strong>Phase Imbalance:</strong> 100 samples with >10% voltage difference between phases</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Early Detection:</strong> Identify voltage quality issues before equipment damage occurs</li>
                    <li><strong>Prevent Downtime:</strong> Avoid costly interruptions from unexpected voltage events</li>
                    <li><strong>Power Quality Compliance:</strong> Maintain adherence to IEEE 1159 and EN 50160 standards</li>
                    <li><strong>Proactive Maintenance:</strong> Address root causes of voltage disturbances early</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Voltage anomalies indicate underlying grid problems such as loose connections, failing equipment, or overloaded circuits. The Isolation Forest algorithm excels at detecting outliers in multi-dimensional voltage data without requiring labeled training data. Anomalies are identified based on their ease of isolation, providing fast detection validated against IEEE voltage quality benchmarks.</p>
            </div>
        </div>
    </div>
</div>

<!-- Harmonic Analysis Info Modal -->
<div class="modal" id="harmonicModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-wave-square"></i> Harmonic Analysis</h5>
                <button class="close" onclick="closeModal('harmonicModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model analyzes harmonic distortion in the power system by calculating Total Harmonic Distortion (THD) and identifying problematic harmonic frequencies that can damage equipment and reduce power quality.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Random Forest Classifier + FFT Analysis</strong> with 50 decision trees. Combines Fast Fourier Transform for frequency decomposition with Random Forest to classify THD severity levels (Low/Medium/High).</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Clean Power (Low THD):</strong> 300 samples with THD <5%, typical of well-designed systems</li>
                    <li><strong>Moderate Distortion (Medium THD):</strong> 150 samples with THD 5-10%, common with VFDs</li>
                    <li><strong>High Distortion (High THD):</strong> 50 samples with THD >10%, indicating serious power quality issues</li>
                    <li><strong>Features:</strong> 3rd, 5th, 7th, 9th harmonic magnitudes, voltage variance, current distortion</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Identify Pollution Sources:</strong> Locate equipment generating harmonics (VFDs, switching power supplies)</li>
                    <li><strong>Filter Specification:</strong> Design appropriate harmonic mitigation solutions</li>
                    <li><strong>Prevent Overheating:</strong> Avoid transformer and neutral conductor damage from harmonics</li>
                    <li><strong>IEEE 519 Compliance:</strong> Ensure power quality meets industry standards for harmonic limits</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Harmonic distortion is caused by non-linear loads that draw non-sinusoidal currents. IEEE 519 defines acceptable harmonic limits to prevent equipment malfunction, overheating, and resonance issues. The FFT decomposes waveforms into frequency components, while the Random Forest classifier leverages extensive training data to accurately categorize THD severity and guide operator response.</p>
            </div>
        </div>
    </div>
</div>

<!-- Frequency Stability Prediction Info Modal -->
<div class="modal" id="frequencyModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title"><i class="fas fa-chart-line"></i> Frequency Stability Prediction</h5>
                <button class="close" onclick="closeModal('frequencyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model predicts future frequency behavior by analyzing historical frequency trends, enabling operators to anticipate and prevent frequency excursions that could trigger protective relays or cause equipment damage.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>LSTM (Long Short-Term Memory) Neural Network</strong> with 2 layers [64, 32 units], using a 100-point sliding window to predict the next 10 time steps. Trained with dropout (0.2) for regularization.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>30 Days Time-Series Data:</strong> Hourly frequency measurements capturing daily and weekly patterns</li>
                    <li><strong>Peak Load Periods:</strong> Morning (6-9h) and evening (17-22h) with higher frequency variability</li>
                    <li><strong>Off-Peak Stability:</strong> Night hours (22h-6h) with minimal frequency deviation</li>
                    <li><strong>Load Events:</strong> Large motor starts, generator trips causing ±0.1-0.5Hz deviations</li>
                    <li><strong>Normal Range:</strong> 49.8-50.2Hz with occasional excursions to 49.5-50.5Hz limits</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Predictive Control:</strong> Anticipate frequency deviations 10 steps ahead for proactive response</li>
                    <li><strong>Generator Dispatch:</strong> Optimize unit commitment and AGC setpoints based on predictions</li>
                    <li><strong>Prevent Excursions:</strong> Avoid frequency trips beyond statutory limits (49.5-50.5Hz)</li>
                    <li><strong>Load-Generation Balance:</strong> Maintain real-time balance preventing cascading failures</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Frequency is the real-time indicator of load-generation balance. LSTM networks excel at time-series prediction by maintaining memory of long-term dependencies in frequency patterns. The model captures daily load cycles, weekend/weekday differences, and transient disturbances. Validated against NERC frequency response standards, the predictions enable operators to maintain grid stability within ±0.2Hz during normal conditions and respond effectively to contingencies.</p>
            </div>
        </div>
    </div>
</div>

<!-- Phase Imbalance Classification Info Modal -->
<div class="modal" id="imbalanceModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger">
                <h5 class="modal-title"><i class="fas fa-balance-scale"></i> Phase Imbalance Classification</h5>
                <button class="close" onclick="closeModal('imbalanceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <h5><i class="fas fa-question-circle"></i> What does this model do?</h5>
                <p>This model classifies the severity of phase imbalance by analyzing voltage, current, and power differences across the three phases, categorizing conditions as Normal, Warning, or Critical to guide load balancing actions.</p>

                <h5><i class="fas fa-brain"></i> Algorithm Used</h5>
                <p><strong>Decision Tree Classifier</strong> with Gini impurity criterion, max depth of 8, min samples split of 10. Trained on 500 scenarios with varying levels of phase imbalance.</p>

                <h5><i class="fas fa-database"></i> Training Dataset Logic</h5>
                <ul>
                    <li><strong>Balanced Operation (Normal):</strong> 250 samples with phase imbalance <5%, evenly distributed loads</li>
                    <li><strong>Moderate Imbalance (Warning):</strong> 150 samples with 5-15% imbalance, single-phase heavy loads</li>
                    <li><strong>Severe Imbalance (Critical):</strong> 100 samples with >15% imbalance, risk of neutral overload</li>
                    <li><strong>Features:</strong> Voltage/current/power imbalance percentages, phase currents, neutral current, balance score</li>
                </ul>

                <h5><i class="fas fa-lightbulb"></i> Why is this useful for grid operators?</h5>
                <ul>
                    <li><strong>Early Warning System:</strong> Detect imbalanced loads before causing transformer or neutral damage</li>
                    <li><strong>Load Redistribution:</strong> Guide decisions to balance single-phase loads across phases</li>
                    <li><strong>Equipment Protection:</strong> Prevent overheating of transformers, cables, and neutral conductors</li>
                    <li><strong>Efficiency Improvement:</strong> Reduce losses from neutral current circulation (I²R losses)</li>
                </ul>

                <h5><i class="fas fa-check-circle"></i> Scientific Justification</h5>
                <p>Phase imbalance creates negative sequence currents that cause additional heating in three-phase equipment and circulate current through the neutral conductor. IEEE and IEC standards recommend keeping voltage imbalance below 2% and current imbalance below 10%. The Decision Tree classifier provides interpretable decision rules matching engineering practice, accurately categorizing severity levels to enable timely corrective action before equipment damage occurs.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('show');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.classList.remove('show');
        }
    }

    // Use global API_URL from base.html
    const token = '{{ request.session.access_token }}';
    let isSimulation = false;
    let voltageAnomalyChart, harmonicChart, frequencyChart, imbalanceChart;

    // Initialize charts
    function initCharts() {
        // Voltage Anomaly Chart
        const voltageCtx = document.getElementById('voltageAnomalyChart').getContext('2d');
        voltageAnomalyChart = new Chart(voltageCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Anomaly Score',
                    data: [],
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 1, title: { display: true, text: 'Anomaly Score' } }
                }
            }
        });

        // Harmonic Chart
        const harmonicCtx = document.getElementById('harmonicChart').getContext('2d');
        harmonicChart = new Chart(harmonicCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'THD Percentage',
                    data: [],
                    backgroundColor: '#f39c12'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 15, title: { display: true, text: 'THD (%)' } }
                }
            }
        });

        // Frequency Chart
        const frequencyCtx = document.getElementById('frequencyChart').getContext('2d');
        frequencyChart = new Chart(frequencyCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Historical Frequency',
                    data: [],
                    borderColor: '#2ecc71',
                    backgroundColor: 'rgba(46, 204, 113, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Predicted',
                    data: [],
                    borderColor: '#3498db',
                    borderDash: [5, 5],
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { min: 49, max: 51, title: { display: true, text: 'Frequency (Hz)' } }
                }
            }
        });

        // Imbalance Chart
        const imbalanceCtx = document.getElementById('imbalanceChart').getContext('2d');
        imbalanceChart = new Chart(imbalanceCtx, {
            type: 'radar',
            data: {
                labels: ['Voltage Imbalance', 'Current Imbalance', 'Power Imbalance'],
                datasets: [{
                    label: 'Imbalance %',
                    data: [0, 0, 0],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.2)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: { beginAtZero: true, max: 20, title: { display: true, text: 'Percentage (%)' } }
                }
            }
        });
    }

    // Fetch and update all visualizations
    async function updateVisualizations() {
        try {
            const params = isSimulation ? '?is_simulation=true' : '?is_simulation=false';

            // Voltage Anomaly Detection
            const voltageResp = await fetch(`${API_URL}/api/ml/monitoring/voltage-anomaly${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const voltageData = await voltageResp.json();

            if (voltageData.data && voltageData.data.length > 0) {
                const limited = voltageData.data.slice(-200);
                voltageAnomalyChart.data.labels = limited.map(d => new Date(d.timestamp).toLocaleTimeString());
                voltageAnomalyChart.data.datasets[0].data = limited.map(d => d.anomaly_score);
                voltageAnomalyChart.update();

                const latest = limited[limited.length - 1];
                document.getElementById('anomalyScore').textContent = latest.anomaly_score.toFixed(3);
                document.getElementById('avgVoltage').textContent = latest.v_avg.toFixed(1) + 'V';

                const statusEl = document.getElementById('voltageStatus');
                if (latest.is_anomaly) {
                    statusEl.className = latest.severity === 'High' ? 'risk-badge risk-high' : 'risk-badge risk-medium';
                    statusEl.textContent = 'Anomaly: ' + latest.severity;
                } else {
                    statusEl.className = 'risk-badge risk-low';
                    statusEl.textContent = 'Normal';
                }
            }

            // Harmonic Analysis
            const harmonicResp = await fetch(`${API_URL}/api/ml/monitoring/harmonic-analysis${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const harmonicData = await harmonicResp.json();

            if (harmonicData.data && harmonicData.data.length > 0) {
                const limited = harmonicData.data.slice(-200);
                harmonicChart.data.labels = limited.map(d => new Date(d.timestamp).toLocaleTimeString());
                harmonicChart.data.datasets[0].data = limited.map(d => d.thd_percentage);
                harmonicChart.update();

                const latest = limited[limited.length - 1];
                document.getElementById('thdValue').textContent = latest.thd_percentage.toFixed(2) + '%';
                document.getElementById('thdCategory').textContent = latest.thd_category;

                const thdEl = document.getElementById('thdLevel');
                if (latest.thd_category === 'High') {
                    thdEl.className = 'risk-badge risk-high';
                    thdEl.textContent = 'High';
                } else if (latest.thd_category === 'Medium') {
                    thdEl.className = 'risk-badge risk-medium';
                    thdEl.textContent = 'Medium';
                } else {
                    thdEl.className = 'risk-badge risk-low';
                    thdEl.textContent = 'Low';
                }
            }

            // Frequency Stability
            const freqResp = await fetch(`${API_URL}/api/ml/monitoring/frequency-stability${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const freqData = await freqResp.json();

            if (freqData.historical && freqData.historical.length > 0) {
                const limited = freqData.historical.slice(-200);
                const histLabels = limited.map(d => new Date(d.timestamp).toLocaleTimeString());
                const histData = limited.map(d => d.frequency);

                const predLabels = Array.from({length: 10}, (_, i) => `+${i+1}`);
                const allLabels = [...histLabels, ...predLabels];

                frequencyChart.data.labels = allLabels;
                frequencyChart.data.datasets[0].data = [...histData, ...Array(10).fill(null)];
                frequencyChart.data.datasets[1].data = [...Array(histData.length).fill(null), ...freqData.predictions];
                frequencyChart.update();

                document.getElementById('stabilityScore').textContent = freqData.current.stability_score.toFixed(1);

                const trendEl = document.getElementById('frequencyTrend');
                trendEl.textContent = freqData.current.trend;
                if (freqData.current.trend === 'Stable') {
                    trendEl.className = 'risk-badge risk-low';
                } else if (freqData.current.trend === 'Rising' || freqData.current.trend === 'Falling') {
                    trendEl.className = 'risk-badge risk-medium';
                } else {
                    trendEl.className = 'risk-badge risk-high';
                }
            }

            // Phase Imbalance
            const imbalanceResp = await fetch(`${API_URL}/api/ml/monitoring/phase-imbalance${params}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const imbalanceData = await imbalanceResp.json();

            if (imbalanceData.data && imbalanceData.data.length > 0) {
                const latest = imbalanceData.data[imbalanceData.data.length - 1];

                imbalanceChart.data.datasets[0].data = [
                    latest.voltage_imbalance,
                    latest.current_imbalance,
                    latest.power_imbalance
                ];
                imbalanceChart.update();

                document.getElementById('balanceScore').textContent = latest.balance_score.toFixed(1);
                document.getElementById('maxImbalance').textContent = Math.max(
                    latest.voltage_imbalance,
                    latest.current_imbalance,
                    latest.power_imbalance
                ).toFixed(1) + '%';

                const severityEl = document.getElementById('imbalanceSeverity');
                severityEl.textContent = latest.severity;
                if (latest.severity === 'Critical') {
                    severityEl.className = 'risk-badge risk-high';
                } else if (latest.severity === 'Warning') {
                    severityEl.className = 'risk-badge risk-medium';
                } else {
                    severityEl.className = 'risk-badge risk-low';
                }
            }

        } catch (error) {
            console.error('Error fetching ML data:', error);
        }
    }

    // WebSocket connection for real-time ML predictions
    let mlWebSocket = null;
    let reconnectTimeout = null;

    function connectMLWebSocket() {
        if (mlWebSocket && (mlWebSocket.readyState === WebSocket.OPEN || mlWebSocket.readyState === WebSocket.CONNECTING)) {
            return;
        }

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.hostname}:8000/ws/ml-predictions?is_simulation=${isSimulation}`;

        console.log('Connecting to ML WebSocket:', wsUrl);
        mlWebSocket = new WebSocket(wsUrl);

        mlWebSocket.onopen = () => {
            console.log('ML WebSocket connected - Real-time predictions active');
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
        };

        mlWebSocket.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);

                if (message.type === 'initial_predictions' || message.type === 'update' || message.type === 'ml_update') {
                    updateMLCharts(message.data);
                }
            } catch (error) {
                console.error('Error processing WebSocket message:', error);
            }
        };

        mlWebSocket.onerror = (error) => {
            console.error('ML WebSocket error:', error);
        };

        mlWebSocket.onclose = () => {
            console.log('ML WebSocket disconnected - Will reconnect in 5s');
            mlWebSocket = null;
            reconnectTimeout = setTimeout(() => connectMLWebSocket(), 5000);
        };
    }

    function updateMLCharts(predictions) {
        if (!predictions || !predictions.real_time_monitoring) {
            console.warn('No real-time monitoring data in WebSocket message');
            return;
        }

        const monitoring = predictions.real_time_monitoring;

        // Voltage Anomaly
        if (monitoring.voltage_anomaly_detection) {
            const anomaly = monitoring.voltage_anomaly_detection;
            document.getElementById('anomalyScore').textContent = anomaly.anomaly_score.toFixed(3);
            document.getElementById('avgVoltage').textContent = anomaly.v_avg.toFixed(1) + 'V';

            const statusEl = document.getElementById('voltageStatus');
            if (anomaly.is_anomaly) {
                statusEl.className = 'status-badge status-anomaly';
                statusEl.textContent = 'Anomaly Detected';
            } else {
                statusEl.className = 'status-badge status-normal';
                statusEl.textContent = 'Normal';
            }
        }

        // Harmonic Analysis
        if (monitoring.harmonic_analysis) {
            const harmonic = monitoring.harmonic_analysis;
            document.getElementById('thdValue').textContent = harmonic.thd_percentage.toFixed(2) + '%';
            document.getElementById('thdCategory').textContent = harmonic.thd_category;

            const thdEl = document.getElementById('thdLevel');
            if (harmonic.thd_category === 'High' || harmonic.thd_category === 'Critical') {
                thdEl.className = 'status-badge status-high';
                thdEl.textContent = 'High';
            } else if (harmonic.thd_category === 'Moderate') {
                thdEl.className = 'status-badge status-medium';
                thdEl.textContent = 'Moderate';
            } else {
                thdEl.className = 'status-badge status-low';
                thdEl.textContent = 'Low';
            }
        }

        // Frequency Stability
        if (monitoring.frequency_stability) {
            const freq = monitoring.frequency_stability;
            document.getElementById('stabilityScore').textContent = freq.stability_score.toFixed(1);

            const trendEl = document.getElementById('frequencyTrend');
            if (freq.deviation_from_nominal > 0.1) {
                trendEl.className = 'status-badge status-high';
                trendEl.textContent = 'Unstable';
            } else {
                trendEl.className = 'status-badge status-normal';
                trendEl.textContent = 'Stable';
            }
        }

        // Phase Imbalance
        if (monitoring.phase_imbalance_classification) {
            const imbalance = monitoring.phase_imbalance_classification;
            document.getElementById('balanceScore').textContent = imbalance.balance_score.toFixed(1);
            document.getElementById('maxImbalance').textContent = imbalance.max_imbalance_pct.toFixed(1) + '%';

            const severityEl = document.getElementById('imbalanceSeverity');
            if (imbalance.severity.toLowerCase() === 'high' || imbalance.severity.toLowerCase() === 'critical') {
                severityEl.className = 'status-badge status-high';
                severityEl.textContent = imbalance.severity;
            } else if (imbalance.severity.toLowerCase() === 'medium') {
                severityEl.className = 'status-badge status-medium';
                severityEl.textContent = imbalance.severity;
            } else {
                severityEl.className = 'status-badge status-low';
                severityEl.textContent = imbalance.severity;
            }
        }
    }

    // Check simulator mode from global variable
    function updateSimulatorMode() {
        isSimulation = isSimulatorMode;
    }

    // Listen for simulator mode changes
    document.addEventListener('simulatorModeChanged', (e) => {
        isSimulation = e.detail.isSimulatorMode;
        updateVisualizations();
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initCharts();
        updateSimulatorMode();
        updateVisualizations();

        // Real-time updates via WebSocket (no polling needed) // TODO: Replace with WebSocket for real-time updates
    });
</script>
{% endblock %}
